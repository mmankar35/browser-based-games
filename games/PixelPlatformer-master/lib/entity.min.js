/* EntityJS v0.2.1 http://entityjs.com | License http://entityjs.com/license */
re=function(selector){return new re.query(selector);};re.version="0.2.1";re._e=[];re._c={};re.ready=function(r){re.ready.c.push(r);window.onload=function(){for(var k in re.ready.c){re.ready.c[k].call(re);}};};re.ready.c=[];re.$=function(s){return re.$.c[s]=re.$.c[s]||(s.charAt(0)=='#')?document.getElementById(s.substr(1)):document.getElementsByTagName(s);};re.$.c={};re.$new=function(n){return document.createElement(n);};re.listener=function(t,c){if(window.addEventListener){window.addEventListener(t,c,true);}else{document.attachEvent('on'+t,c);}};if(!Array.prototype.indexOf){Array.prototype.indexOf=function(o){for(var i=0;i<this.length;i++){if(this[i]==o){return i;}}
return-1;}}
var __z=function(n,r){this._checkFinal();if(!this[n]){this[n]=[];}
if(typeof r=='string'){this[n]=this[n].concat(r.split(' '));}else{this[n]=this[n].concat(r);}
return this;};re.comp=re.c=function(title){if(!re._c[title]){re._c[title]=new re.comp.init(title);}
return re._c[title];};re.comp.init=function(name){this.name=name;this._re_signals={};this._re_inherits={};this._re_extends={};this._re_final=false;};re.comp.init.prototype={_checkFinal:function(){if(this._re_final){throw this.name+' is final.';}},global:function(obj,value){this._checkFinal();if(arguments.length==1){for(var type in obj){this[type]=obj[type];}}else{this[obj]=value;}
return this;},require:function(r){return __z.call(this,'_re_requires',r);},assert:function(r){return __z.call(this,'_re_asserts',r);},implement:function(r){return __z.call(this,'_re_implments',r);},alias:function(s){this._checkFinal();var p=s.split(' ');if(p.length>1){for(var i in p){this.alias(p[i]);}
return this;}
if(s.charAt(0)=='-'){if(re._c[s.substr(1)]==this){delete re._c[s.substr(1)];}}else{re._c[s]=this;}
return this;},addSignal:function(){return re.e.init.prototype.addSignal.apply(this,arguments);},removeSignal:function(){return re.e.init.prototype.removeSignal.apply(this,arguments);},signal:function(){return re.e.init.prototype.signal.apply(this,arguments);},inherit:function(d,value){this._checkFinal();if(arguments.length==1){for(var k in d){this._re_inherits[k]=d[k];}}else{this._re_inherits[d]=value;}
return this;},namespace:function(obj,value){this._checkFinal();var name=this.name+'_';if(arguments.length==1){for(var k in obj){this._re_extends[name+k]=obj[k];}}else{this._re_extends[name+obj]=value;}
return this;},extend:function(d,value){this._checkFinal();if(!this._re_extends){this._re_extends={};}
if(arguments.length==1){for(var k in d){this._re_extends[k]=d[k];}}else{this._re_extends[d]=value;}
return this;},init:function(method){this._checkFinal();this._re_init=method;return this;},dispose:function(method){this._checkFinal();this._re_dispose=method;return this;},lock:function(){this._checkFinal();this._re_final=true;return this;},run:function(method){this._checkFinal();method.call(this);return this;}};(function(re){var q=function(c,count){if(!count){return new re.entity.init(c);}
var q=re();for(var i=0;i<count;i++){q._e.push(re.e(c));}
return q;};q.id=0;var e=function(c){this._re_comps=[];this._re_signals={};this.id=q.id+'';q.id++;re._e.push(this);this.addComp(c);};var p=e.prototype;p.id='';p.addComp=function(com){this._re_comp(com);if(this._re_interface){for(var i in this._re_interface){if(!this.hasOwnProperty(this._re_interface[i])){throw'implementation: '+this._re_interface[i]+' missing';}}}
if(this._re_asserts){for(var t in this._re_asserts){if(this._re_comps.indexOf(c._re_asserts[t])!=-1){throw'assert: '+c.name+' cannot be coupled with '+c._re_asserts[t];}}}
return this;};p.removeComp=function(com){var pieces;if(typeof com=='object'){pieces=com;com=com[0];}else{pieces=com.split(' ');}
if(pieces.length>1){for(var k in pieces){this._re_comp(pieces[k]);}
return this;}
var c=re._c[com];if(!this.has(com))return this;this._re_comps.splice(this._re_comps.indexOf(com),1);if(c){if(c._re_dispose){c._re_dispose.call(this,c);}
c.signal('dispose',this);}};p._re_comp=function(com){if(!com)return this;var pieces;if(typeof com=='object'){pieces=com;com=com[0];}else{pieces=com.split(' ');}
if(pieces.length>1){for(var k in pieces){this._re_comp(pieces[k]);}
return this;}
var c;var vals=com.split(':');com=vals[0];c=re._c[com];vals[0]=c;if(this.has(com))return this;this._re_comps.push(com);if(c){this._re_comp(c._re_requires);if(c._re_implements){if(!this._re_implements){this._re_implements=[];}
this._re_implements=this._re_implements.concat(c._re_implements);}
if(c._re_asserts){if(!this._re_asserts){this._re_asserts=[];}
this._re_asserts=this._re_asserts.concat(c._re_asserts);}
if(c._re_inherits){this.inherit(c._re_inherits);}
if(c._re_extends){this.extend(c._re_extends);}
if(c._re_init){c._re_init.apply(this,vals);}
c.signal('init',this);}
return this;}
p.getComps=function(){return this._re_comps.slice();}
p.clone=function(count){return re.e(this._re_comps,count);}
p.parent=function(comp,method){var a=Array.prototype.slice.call(arguments,2);if(comp==''){re.e.init[method].apply(this,a);}
var c=re._c[comp];if(c._re_extends[method]){return c._re_extends[method].apply(this,a);}
if(c._re_inherits[method]){return c._re_inherits[method].apply(this,a);}
return this;}
p.has=function(comp){if(typeof comp=='string'){comp=re.query._toObj(comp);}
comp.comp=comp.comp||[];comp.id=comp.id||'';comp.signal=comp.signal||[];comp.not=comp.not||[];for(p=0;p<comp.comp.length;p++){if(this._re_comps.indexOf(comp.comp[p])==-1){return false;}}
for(p=0;p<comp.not.length;p++){if(this._re_comps.indexOf(comp.not[p])!=-1){return false;}}
var s;for(p=0;p<comp.signal.length;p++){s=comp.signal[p];if(!this._re_signals[s]||this._re_signals[s].length==0){return false;}}
if(comp.id!=''&&this.id!=comp.id){return false;}
return true;};p.addSignal=function(type,method){if(typeof type=='object'){for(var k in type){this.addSignal(k,type[k]);}}else{if(!this._re_signals[type]){this._re_signals[type]=[];}
this._re_signals[type].push(method);}
return this;};p.removeSignal=function(type,method){if(typeof type=='object'){for(var k in type){this.removeSignal(k,type[k]);}}else{if(typeof method=='function'){for(var k in this._re_signals[type]){if(this._re_signals[type][k]==method){this._re_signals[type].splice(k,1);}}}else{this._re_signals[type]=[];}}
return this;};p.signal=function(type){if(!this._re_signals[type])return this;var b;for(var i=0,l=this._re_signals[type].length;i<l;i++){b=this._re_signals[type];if(!b[i])continue;if(b[i].apply((b[i].c)?b[i].c:this,Array.prototype.slice.call(arguments,1))===false){b.splice(i,1);}}
return this;};p.extend=function(obj,value){var a=typeof obj;if(a=='object'){for(var key in obj){if(!obj.hasOwnProperty(key))continue;this.extend(key,obj[key]);}}else{this[obj]=value;}
return this;}
p.inherit=function(obj,value){if(typeof obj=='object'){for(var key in obj){if(!obj.hasOwnProperty(key))continue;this.inherit(key,obj[key]);}}else{if(!this.hasOwnProperty(obj)||typeof this[obj]!=typeof value){this[obj]=value;}}
return this;}
p.dispose=function(){re._e.splice(re._e.indexOf(this),1);for(var i in this._re_comps){var k=re.c(this._re_comps[i]);if(k._re_dispose){k._re_dispose.call(this,k);}}
this.signal('dispose');return this;}
re.entity=re.e=q;re.entity.init=e;}(re));(function(re){var b=function(assets){return new re.load.init(assets);}
b.path="";b.imageExt='img';b.soundExt='sfx';b.images=['gif','jpg','jpeg','png'];b.sounds=['wav','mp3','aac','ogg'];var l=function(assets){if(typeof assets=='string'){this.assets=assets.split(' ');}else{this.assets=assets;}
var a;for(var i=0;i<this.assets.length;i++){this.total++;a=this.assets[i];var j=a.lastIndexOf('.')+1;var ext=a.substr(j).toLowerCase();var s=a;var d=a.lastIndexOf('/');if(d!=-1){a=a.substr(d+1,a.length);}
var n=a.substr(0,j);if(re.load.images.indexOf(ext)!=-1){this._loadImg(s,a,n);}else if(re.load.sounds.indexOf(ext)!=-1){if(!re.support||re.support(ext)){this._loadSound(s,a,n);}}}
return this;}
var p=l.prototype;p.current=0;p.total=0;p._loadImg=function(src,a,n){var that=this;var img=new Image();re.c(a).alias(n+re.load.imgExt).global({bitmap:img}).extend({bitmap:img});img.onload=function(){re.c(a).extend({bisect:img.width,sizeX:img.width,sizeY:img.height});that.current++;if(that._p){that._p.call(that,that.current,that.total,a);}
if(that.current>=that.total){if(that._s){that._s.call(that,that.assets);}}};img.onerror=function(){if(that._e){that._e.call(that,a);}};img.src=re.load.path+src;return this;}
p._loadSound=function(src,a,n){var that=this;var s=new Audio(re.load.path+src);s.preload="auto";s.load();re.c(a).alias(n+re.load.soundExt).global({sound:s}).extend({sound:s});s.addEventListener('canplaythrough',function(){that.current++;if(that._p){that._p.call(that,that.current,that.total,a);}
if(that.current>=that.total){if(that._s){that._s.call(that,that.assets);}}},false);s.addEventListener('error',function(){if(that._e){that._e.call(that,a);}},false);}
p.progress=function(m){this._p=m;return this;}
p.complete=function(m){this._s=m;return this;}
p.error=function(m){this._e=m;return this;}
re.load=b;re.load.init=l;}(re));(function(re){var q=function(selector){this._e=[];if(selector){this.query(selector);}}
q._toObj=function(query){if(q.c[query]){return q.c[query];}
var temp=query.split(' ');var comps=[];var signals=[];var minus=[];var id='';var fl;var val;for(var j=0;j<temp.length;j++){fl=temp[j].charAt(0);val=temp[j].substr(1);if(fl=='^'){signals.push(val);}else if(fl=='-'){minus.push(val);}else if(fl=='#'){id=val;}else{comps.push(temp[j]);}}
var comp={comp:comps,signal:signals,not:minus,id:id};q.c[query]=comp;return comp;}
q.c={};var p=q.prototype;p.query=function(select){select=select||'';var i=0;if(typeof select=='string'){if(select=='*'){this._e=re._e.slice();return this;}
var obj=q._toObj(select);var en;main:for(;i<re._e.length;i++){en=re._e[i];if(en.has(obj)){this._e.push(en);}}}else if(typeof select=='function'){for(;i<re._e.length;i++){if(select.call(re._e[i],i)){this._e.push(re._e[i]);}}}
return this;}
p.toArray=function(){return this._e.slice();}
p.method=function(m){var b=Array.prototype.slice.call(arguments,1);this.each(function(){this[m].apply(this,b);});return this;}
p.each=function(m){var l=this._e.length,i=-1,e;while(++i<l&&(e=this._e[i])&&m.call(e,i,l)!==false);return this;}
p.map=function(w,method){var x=0;var y=0;for(var i=0;i<this._e.length;i++){if(method.call(this._e[i],x,y)==false)break;x++;if(x==w){x=0;y++;}}}
p.getComps=function(){var l=[];this.each(function(){l.concat(this.getComps());});return l;}
p.random=function(){return this._e[~~(Math.random()*this._e.length)];}
p.pluck=function(value){var t=[];var k=value.split(' ');this.each(function(){var o={};for(var p in k){if(k.hasOwnProperty(p)){o[k[p]]=this[k[p]];}}
t.push(o);});return t;}
p.extend=function(obj,value){this.each(function(){this.extend(obj,value);});return this;}
p.inherit=function(obj,value){this.each(function(){this.inherit(obj,value);});return this;}
p.comp=function(c){this.each(function(ref){this.comp(c);});return this;}
p.signal=function(type,method){var p=arguments;this.each(function(ref){this.signal.apply(this,p);});return this;}
p.length=function(){return this._e.length;}
p.filter=function(method){var q=re();var that=this;this.each(function(i){if(method.call(this,i)){q.push(this);}});return q;}
p.has=function(comp){for(var i=0;i<this._e.length;i++){if(!this._e.has(comp)){return false;}}
return this;}
p.dispose=function(){this.each(function(){this.dispose();});return this;}
p.get=function(index){return this._e[index];}
p.put=function(entity){this._e.push(entity);return this;}
re.query=q;}(re));re.c('system').inherit({contextType:'2d',clearColor:'#f9f9f9',stepSize:0.03,running:false,sizeX:0,sizeY:0}).extend({clear:function(color){if(color){this.context.fillStyle=color;this.context.fillRect(0,0,this.sizeX,this.sizeY);}else{this.context.clearRect(0,0,this.sizeX,this.sizeY);}
return this;},start:function(){if(!this.running){this.running=true;var that=this;(function mainLoop(){that.system_loop.call(that);if(that.running){that.requestAnimationFrame(mainLoop,that.canvas);}})();}
return this;},loop:function(m){this.system_loop=m;return this;},stop:function(){this.running=false;return this;},init:function(canvasId,screen,contextType){this.addComp('polyfill ticker timestep');this.canvas=re.$(canvasId);this.contextType=contextType||this.contextType;this.context=this.canvas.getContext(this.contextType);this.sizeX=this.canvas.width;this.sizeY=this.canvas.height;screen=screen||re.screen;if(screen){screen.sizeX=this.sizeX;screen.sizeY=this.sizeY;screen.regX=this.sizeX*0.5;screen.regY=this.sizeY*0.5;}
return this;},system_loop:function(){this.timestep(this.tick(),function(){re._c.update.update.call(re._c.update,this,this.stepSize);});this.clear(this.clearColor);re._c.draw.draw.call(re._c.draw,this);}}).run(function(){re.system=re.sys=re.e('system');});re.c('draw').global({listeners:[],draw:function(s){var l=this.listeners;for(var k=0,le=l.length,b;k<le;++k){b=l[k];if(b&&b.sys==s&&b.drawing&&b.isVisible()){b.draw_render(s.context);}}}}).implement('draw').init(function(c){c.listeners.push(this);this.screen=re.screen;}).dispose(function(c){c.listeners.splice(c.listeners.indexOf(this),1);}).inherit({sys:re.sys,drawing:true,rotation:0,alpha:1,scaleX:1,scaleY:1,posX:0,posY:0,sizeX:1,sizeY:1,regX:0,regY:0}).extend({cache:function(){if(!this.image)return this;this.clearCache();var c=re.$new('canvas');var s=Math.max(this.image.width,this.image.height);c.width=s;c.height=s;this.draw_render(c.getContext(re.sys.contextType));this.canvasCache=c;return this;},clearCache:function(){this.canvasCache=null;},drawFirst:function(){var l=re.c('draw').listeners;l.splice(l.indexOf(this),1);l.unshift(this);return this;},drawLast:function(){var l=re.c('draw').listeners;l.splice(l.indexOf(this),1);l.push(this);return this;},drawAfter:function(en){var l=re.c('draw').listeners;var him=l.indexOf(en);var me=l.indexOf(this);if(him>me){var t=l[him];l[him]=l[me];l[me]=t;}
return this;},drawBefore:function(en){var l=re.c('draw').listeners;var him=l.indexOf(en);var me=l.indexOf(this);if(him<me){var t=l[him];l[him]=l[me];l[me]=t;}
return this;},getScreenX:function(){var x=this.posX;if(this.screen)x-=this.screen.posX;return x;},getScreenY:function(){var y=this.posY;if(this.screen)y-=this.screen.posY;return y;},isVisible:function(){return(!this.screen||this.screen.touches(this.posX-this.regX,this.posY-this.regY,this.sizeX,this.sizeY));}}).namespace({render:function(c){if(!c)c=this.sys.context;this.draw_before(c);this.draw(c);this.draw_after(c);},before:function(c){c.save();if(this.alpha!=1)
c.globalAlpha=this.alpha;c.translate(this.getScreenX(),this.getScreenY());if(this.rotation!=0)
c.rotate(this.rotation*Math.PI/180);if(this.scaleX!=1||this.scaleY!=1)
c.scale(this.scaleX,this.scaleY);},after:function(c){c.restore();}});re.c('ticker').inherit({time:0,maxTick:0.05}).init(function(){this.lastTime=Date.now();}).extend({tick:function(){var wall=Date.now();var delta=(wall-this.lastTime)/1000;this.lastTime=wall;var timeDelta=Math.min(delta,this.maxTick);this.time+=timeDelta;return timeDelta;}});re.c('tween').require('update').global({tween:function(obj,time,props){return obj.comp('tween').tween(time,props);}}).namespace({update:function(t){}}).inherit({tweening:false}).extend({tween:function(time,props){this.time=time||5;if(this.tweening){this.removeSignal('update',this.tween_update);}
for(var i in props){if(!props.hasOwnProperty(i))continue;this.tween_props[i]={s:re.sys.stepSize,i:props[i]};}
return this;}}).init(function(){this.tween_props={};});re.tween=re.c('tween').tween;re.c('update').global({listeners:[],update:function(s,t){var l=this.listeners;for(var k=0,le=l.length,b;k<le;++k){b=l[k];if(b&&b.sys==s&&b.updating){b.signal('update',t,s.time);}}}}).inherit({updating:true,sys:re.sys}).extend(function(){var l=re.c('update').listeners;return{updateFirst:function(){l.splice(l.indexOf(this),1);l.unshift(this);return this;},updateLast:function(){l.splice(l.indexOf(this),1);l.push(l);return this;},updateAfter:function(e){var him=l.indexOf(e);var me=l.indexOf(this);if(him>me){var t=l[him];l[him]=l[me];l[me]=t;}
return this;},updateBefore:function(e){var him=l.indexOf(e);var me=l.indexOf(this);if(him<me){var t=l[him];l[him]=l[me];l[me]=t;}
return this;}};}()).init(function(c){c.listeners.push(this);}).dispose(function(c){c.listeners.splice(c.listeners.indexOf(this),1);});re.c('wait').require('update').extend({wait:function(time,callback){var c=0;this.addSignal('update',function(t){c+=t;if(c>=time){this.callback.apply(this,Array.prototype.slice.call(arguments,2));return false;}});}});re.c('anchor').extend({centerX:function(o){o=o||0;this.posX=Math.floor(re.sys.sizeX*0.5-this.sizeX*0.5+o);return this;},centerY:function(o){o=o||0;this.posY=Math.floor(re.sys.sizeY*0.5-this.sizeY*0.5+o);return this;},right:function(x){x=x||0;this.posX=Math.floor(re.sys.sizeX-this.sizeX+x);return this;},left:function(x){x=x||0;this.posX=Math.floor(x);return this;},top:function(y){y=y||0;this.posY=Math.floor(y);return this;},bottom:function(y){y=y||0;this.posY=Math.floor(re.sys.sizeY-this.sizeY+y);return this;}}).inherit({sizeX:0,sizeY:0,posX:0,posY:0});re.c('bitfont').require('draw').inherit({text:'',charOffset:32}).extend({isVisible:function(){return this.text.length!=0&&this.bitmap&&this.parent('draw','isVisible');},draw:function(c){var slot=0,charWidth,code,charPos;for(var i=0,l=this.text.length;i<l;++i){code=this.text.charCodeAt(i)-this.charOffset;charWidth=this.charWidths[code];if(!this.charCache[code]){charPos=0;for(var p=0;p<code;++p){charPos+=this.charWidths[p]+1;}
this.charCache[code]=charPos;}
c.drawImage(this.bitmap,this.charCache[code],0,charWidth,this.bitmap.height,-this.regX+slot,-this.regY,charWidth,this.bitmap.height);slot+=charWidth;}
this.sizeX=slot;this.sizeY=this.bitmap.height;},updateSize:function(){var t=0;for(var p=0;p<this.text.length;p++){t+=this.charWidths[p];}
this.sizeX=t;if(this.bitmap){this.sizeY=this.bitmap.height;}else{this.sizeY=0;}
return this;},setText:function(text){this.text=text;this.updateSize();return this;}}).init(function(){if(!this.charCache){this.charCache={};}
this.updateSize();});re.c('bitmap').require('draw').extend({setBitmap:function(b){this.bitmap=b;if(b){this.sizeX=b.width;this.sizeY=b.height;}
return this;},isVisible:function(){return this.bitmap&&this.parent('draw','isVisible');},draw:function(c){c.drawImage(this.bitmap,-this.regX,-this.regY,this.sizeX,this.sizeY);return this;}}).init(function(){if(this.bitmap){this.setBitmap(this.bitmap);}});re.c('circle').require('draw').inherit({color:'#82d5f4'}).extend({draw:function(c){c.fillStyle=this.color;c.beginPath();c.arc(-this.regX,-this.regY,this.sizeX,0,Math.PI*2,true);c.closePath();c.fill();},setRadius:function(r){this.sizeX=this.sizeY=r;return this;}});re.c('font').require('draw').inherit({font:"14px sans-serif",textColor:'#000000',textAlign:'',text:''}).extend({isVisible:function(){return this.text.length!=0;},draw:function(c){c.font=this.font;c.fillStyle=this.textColor;c.fillText(this.text,-this.regX,-this.regY);}});re.c('group').inherit({posX:0,posY:0}).extend({group:function(){for(var i=0;i<arguments.length;i++){arguments[i].comp('group').group}},ungroup:function(e){},getScreenX:function(){var x=this.posX;if(this.group)x+=this.group.posX;if(this.screen)x+=this.screen.posX;return x;},getScreenY:function(){var y=this.posY;if(this.group)y+=this.group.posY;if(this.screen)y+=this.screen.posY;return y;},getGroupX:function(){var x=this.posX;if(this.group){x+=this.group.posX;}
return x;},getGroupY:function(){var y=this.posY;if(this.group){y+=this.group.posY;}
return y;},setGroupX:function(x){},setGroupY:function(y){}});re.c('rect').require('draw').inherit({color:'#82d5f4'}).extend({draw:function(c){c.fillStyle=this.color;c.fillRect(-this.regX,-this.regY,this.sizeX,this.sizeY);}});re.c('screen').require('hittest').extend({setPos:function(x,y){if(arguments.length==1){y=x.posY;x=x.posX;}
this.posX=x-this.regX;this.posY=y-this.regY;return this;}}).inherit({posX:0,posY:0,regX:0,regY:0,sizeX:0,sizeY:0});re.ready(function(){re.screen=re.e('screen');});re.c('sprite').require('bitmap bisect').inherit({frameX:0,frameY:0}).extend({setFrameId:function(id){this.frameX=this.biToXt(id);this.frameY=this.biToYt(id);return this;},getFrameId:function(){return this.toBi(this.frameX,this.frameY);},draw:function(c){c.drawImage(this.bitmap,this.frameX*this.sizeX,this.frameY*this.sizeY,this.sizeX,this.sizeY,-this.regX,-this.regY,this.sizeX,this.sizeY);return this;},flick:function(c){this.setFrameId(c);}});re.c('keyboard').global({listeners:[],keyCodes:{65:'a',66:'b',67:'c',68:'d',69:'e',70:'f',71:'g',72:'h',73:'i',74:'j',75:'k',76:'l',77:'m',78:'n',79:'o',80:'p',81:'q',82:'r',83:'s',84:'t',85:'u',86:'v',87:'w',88:'x',89:'y',90:'z',48:'0',49:'1',50:'2',51:'3',52:'4',53:'5',54:'6',55:'7',56:'8',57:'9',112:'f1',113:'f2',114:'f3',115:'f4',116:'f5',117:'f6',118:'f7',119:'f8',120:'f9',121:'f10',122:'f11',123:'f12',16:'shift',17:'ctrl',18:'alt',24:'cmd',255:'fn',8:'backspace',13:'enter',32:'space',27:'esc',9:'tab',20:'capslock',91:'windows',46:'delete',36:'home',35:'end',33:'pageup',34:'pagedown',37:'left',38:'up',39:'right',40:'down',96:'`',45:'-',187:'=',219:'[',221:']',220:'\\',59:';',222:"'",188:',',190:'.',191:'/'},keyboardEvent:function(e){var that=re.c('keyboard');var c=e.keyCode||e.which;var key=that.keyCodes[c];if(re.c('pressed').preventDefault[key]){if(e.preventDefault)
e.preventDefault();else
e.returnValue=false;}
if(re.c('pressed')._pressed){re.c('pressed')._pressed[key]=(e.type=='keydown');}
for(var k=0;k<that.listeners.length;k++){that.listeners[k].signal(e.type,key,e).signal(e.type+':'+key,key,e);}},active:false,initListeners:function(){if(!this.active){this.active=true;re.listener('keydown',this.keyboardEvent,false);re.listener('keyup',this.keyboardEvent,false);}}}).init(function(c){c.initListeners();c.listeners.push(this);}).dispose(function(c){c.listeners.splice(c.listeners.indexOf(this),1);});re.c('mouse').global({listeners:[],mouseAction:function(e){var b;if(e.which==null){if(e.button<2){b='left';}else if(e.button==4){b='middle';}else{b='right';}}else{if(e.which<2){b='left';}else if(e.which==2){b='middle';}else{b='right';}}
b='mouse:'+b;if(re.c('pressed')._pressed){re.c('pressed')._pressed[b]=(e.type=='mousedown');}
if(re.c('pressed').preventDefault){if(re.c('pressed').preventDefault[b]){if(e.preventDefault)
e.preventDefault();else
e.returnValue=false;}}
re.c('mouse').mouseEvent(e);},mouseEvent:function(e){var x;var y;if(e.pageX||e.pageY){x=e.pageX;y=e.pageY;}else{x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop;}
if(re.sys.canvas){x-=re.sys.canvas.offsetLeft;y-=re.sys.canvas.offsetTop;}
if(x<0||y<0||y>re.sys.sizeY||x>re.sys.sizeX){return;}
var that=re.c('mouse');for(var i=0;i<that.listeners.length;i++){that.listeners[i].signal(e.type,x,y,e);}},active:false,initListeners:function(){if(!this.active){this.active=true;re.listener('mousedown',this.mouseAction,false);re.listener('mouseup',this.mouseAction,false);re.listener('mousemove',this.mouseEvent,false);re.listener('click',this.mouseEvent,false);re.listener('dblclick',this.mouseEvent,false);re.listener('contextmenu',this.mouseEvent,false);}}}).init(function(c){c.initListeners();c.listeners.push(this);}).dispose(function(c){c.listeners.splice(c.listeners.indexOf(this),1);});re.c('pressed').global({_pressed:{},preventDefault:{}}).extend({pressed:function(){return re.pressed.apply(this,arguments);},preventDefault:function(){re.preventDefault.apply(this,arguments);return this;}}).init(function(){re._c.keyboard.initListeners();re._c.mouse.initListeners();re._c.touch.initListeners();});re.pressed=function(key){var that=re.c('pressed');var c=arguments;if(typeof key=='object')c=key;for(var i=0;i<c.length;i++){if(that._pressed[c[i]]){return true;}}
return false;}
re.preventDefault=function(key){var p=key.split(' ');if(p.length>1){for(var k in p){this.preventDefault(p[k]);}
return this;}
re.c('pressed').preventDefault[key]=true;return this;}
re.c('touch').global({touchEvent:function(e){},active:false,initListeners:function(){if(!this.active){this.active=true;re.listener('touchstart',this.touchEvent,false);re.listener('touchmove',this.touchEvent,false);re.listener('touchend',this.touchEvent,false);}}}).init(function(c){c.initListeners();});re.c('bind').require('update').namespace({update:function(){if(!this.bind)return;if(this.posX<this.bindMinX){this.posX=this.bindMinX;}else if(this.posX>this.bindMaxX){this.posX=this.bindMaxX;}
if(this.posY<this.bindMinY){this.posY=this.bindMinY;}else if(this.posY>this.bindMaxY){this.posY=this.bindMaxY;}}}).inherit({posX:0,posY:0,bindMinX:0,bindMinY:0,bindMaxX:10,bindMaxY:10,bind:true}).extend({setBind:function(minx,miny,maxx,maxy){this.bindMinX=minx;this.bindMinY=miny;this.bindMaxX=maxx;this.bindMaxY=maxy;return this;}}).init(function(){this.addSignal('update',this.bind_update);}).dispose(function(){this.removeSignal('update',this.bind_update);});re.bisect=re.c('bisect').global({biToX:function(bi,width,size){return this.biToXt(bi,width)*size;},biToY:function(bi,width,size){return this.biToYt(bi,width)*size;},biToXt:function(bi,width,size){return Math.floor(bi%(width/size));},biToYt:function(bi,width,size){return Math.floor((bi*size)/(width-0.1));},toBi:function(xt,yt,w,s){return xt+(yt*(w/s));}}).extend({biToX:function(bi){return this.biToXt(bi,this.bisect)*this.sizeX;},biToY:function(bi){return this.biToYt(bi,this.bisect)*this.sizeY;},biToXt:function(bi){return Math.floor(bi%(this.bisect/this.sizeX));},biToYt:function(bi){return Math.floor((bi*this.sizeY)/(this.bisect-0.1));},toBi:function(xt,yt){return xt+(yt*(this.bisect/this.sizeX));}}).inherit({bisect:1,sizeX:1,sizeY:1});re.c('body').extend({touches:function(x,y,w,h){return!(x>this.posX+this.bodX-this.padX||x+w<this.posX+this.padX||y>this.posY+this.bodY-this.padY||y+h<this.posY+this.padY);},touchesBody:function(x,y,bx,by,px,py){return!(x+px>this.posX+this.bodX+this.padX||x+bx-px<this.posX+this.padX||y+py>this.posY+this.bodY-this.padY||y+by-py<this.posY+this.padY);}}).inherit({padX:0,padY:0,bodX:1,bodY:1});re.c('drag').inherit({posX:0,posY:0}).init(function(){this.drag_pos={x:0,y:0};}).extend({anchorDrag:function(x,y){this.drag_pos.x=x;this.drag_pos.y=y;},updateDrag:function(x,y){this.posX+=x-this.drag_pos.x;this.posY+=y-this.drag_pos.y;this.drag_pos.x=x;this.drag_pos.y=y;}});re.c('hitmap').require('arraymap').extend({hitValue:1,checkAxisX:function(value,x,y,vx,vy){return value==this.hitValue;},checkAxisY:function(value,x,y,vx,vy){return value==this.hitValue;},checkHit:function(posX,posY,velX,velY,bodX,bodY,padX,padY){if(arguments.length==1){var velX=posX.velX;var velY=posX.velY;var bodX=posX.bodX;var bodY=posX.bodY;var padX=posX.padX;var padY=posX.padY;var posY=posX.posY;posX=posX.posX;}
var res={posX:posX,posY:posY,tarX:-1,tarY:-1};var step=~~(Math.max(Math.abs(velX),Math.abs(velY))/((re.tile.sizeX+re.tile.sizeY)*0.5)+0.5);if(step>1){var sx=velX/step;var sy=velY/step;for(var i=0;i<step&&(sx||sy);i++){this.hitmap_step(res,posX,posY,sx,sy,bodX,bodY,padY,padY);if(res.hitX){sx=0;}
if(res.hitY){sy=0;}}}else{this.hitmap_step(res,posX,posY,velX,velY,bodX,bodY,padX,padY);}
return res;}}).namespace({step:function(res,x,y,vx,vy,width,height,padx,pady){res.posX+=vx;res.posY+=vy;var t,ty,tx;if(vx){t=re.tile.sizeX;var offsetx=(vx>0?width-padx:padx);var firsty=Math.floor((y+pady)/t);var lasty=Math.ceil((y+height-pady)/t);tx=Math.floor((x+vx+offsetx)/t);var offx=(vx<0?t:0);if(tx>=0&&tx<this.lengthX&&lasty>=0&&firsty<this.lengthY){for(ty=firsty;ty<lasty;ty++){if(this.map[ty]){this.signal('hit',this.map[ty][tx],tx,ty);if(this.checkAxisX(this.map[ty][tx],x,y,vx,vy)){res.hitX=true;res.posX=tx*t+offx-offsetx;res.tarX=tx*t;res.tarY=ty*t;break;}}}}}
if(vy){t=re.tile.sizeY;var offsety=(vy>0?height-pady:pady);var firstx=Math.floor((res.posX+padx)/t);var lastx=Math.ceil((res.posX+width-padx)/t);ty=Math.floor((y+vy+offsety)/t);var offy=(vy<0?t:0);if(ty>=0&&ty<this.lengthY&&lastx>=0&&firstx<this.lengthX){for(tx=firstx;tx<lastx;tx++){if(this.map[ty]){this.signal('hit',this.map[ty][tx],tx,ty);if(this.checkAxisY(this.map[ty][tx],x,y,vx,vy)){res.hitY=true;res.posY=ty*t+offy-offsety;res.tarX=tx*t;res.tarY=ty*t;break;}}}}}}});re.c('hittest').inherit({posX:0,posY:0,sizeX:0,sizeY:0,touches:function(x,y,w,h){return!(x>this.posX+this.sizeX||x+w<this.posX||y>this.posY+this.sizeY||y+h<this.posY);}});re.physics=re.c('physics').require('update').global({graX:0,graY:0,minVel:0.01}).inherit({posX:0,posY:0,velX:0,velY:0,velMaxX:100,velMaxY:100,friX:0.9,friY:0.4,accX:0,accY:0,resX:0,resY:0,masX:1,masY:1,padX:0,padY:0,bodX:1,bodY:1}).namespace({update:function(t){this.velX=this.force(this.velX,this.accX,this.friX,this.graX,this.masX,this.velMaxX);this.velY=this.force(this.velY,this.accY,this.friY,this.graY,this.masY,this.velMaxY);if(this.hitmap){this.aftermath(this.hitmap.checkHit(this));}else{this.aftermath(this.posX+this.velX,this.posY+this.velY);}}}).extend({aftermath:function(posx,posy,hitx,hity,tarx,tary){if(arguments.length==1){hitx=posx.hitX;hity=posx.hitY;tarx=posx.tarX;tary=posx.tarY;posy=posx.posY;posx=posx.posX;}
this.posX=posx;this.posY=posy;this.signal('aftermath',hitx,hity,tarx,tary);if(hitx){this.velX=this.forceRes(this.velX,this.resX);}
if(hity){this.velY=this.forceRes(this.velY,this.resY);}},forceRes:function(vel,res){return vel*-res;},forceGra:function(gra,mas){return gra*mas;},forceVel:function(vel,acc,fri){return(vel+acc)*fri;},force:function(vel,acc,fri,gra,mas,max){var v=this.forceVel(vel,acc,fri)+this.forceGra(gra,mas);v=Math.min(max,Math.max(-max,v));if(Math.abs(v)<re.physics.minVel){v=0;}
return v;},isIdle:function(){return(this.velY==0&&this.velX==0&&this.accX==0&&this.accY==0);}}).init(function(c){this.hitmap=re.hitmap;this.graX=c.graX;this.graY=c.graY;this.addSignal('update',this.physics_update);}).dispose(function(){this.removeSignal('update',this.physics_update);});re.c('point').inherit({posX:0,posY:0}).extend({setPos:function(x,y){if(arguments.length==1){if(x.y)
this.posY=x.posY;if(x.x)
this.posX=x.posX;}else{this.posX=x;this.posY=y;}
return this;},setPosX:function(x){this.posX=x;return this;},setPosY:function(y){this.posY=y;return this;},distanceTo:function(x,y){if(arguments.length==1){y=x.posY;x=x.posX;}
var kx,ky;kx=x-this.posX>>31;ky=y-this.posY>>31;return Math.round(((xt-this.posX^kx)-kx)+((yt-this.posY^ky)-ky));}});re.tile=re.c('tile').global({sizeX:40,sizeY:40,roundX:function(x,size){if(arguments.length==1){size=re.tile.sizeX;}
return re.tile.pointToXt(x)*size;},roundY:function(y,size){if(arguments.length==1){size=re.tile.sizeY;}
return re.tile.pointToYt(y)*size;},xToTileX:function(x,size){if(arguments.length==1){size=re.tile.sizeX;}
return Math.round((x-size*0.5)/size);},yToTileX:function(y,size){if(arguments.length==1){size=re.tile.sizeY;}
return Math.round((y-size*0.5)/size);}}).inherit({posX:0,posY:0}).init(function(){if(!this.sizeX)
this.sizeX=re.tile.sizeX;if(!this.sizeY)
this.sizeY=re.tile.sizeY;}).extend({setTileFromPoint:function(x,y){this.posX=re.tile.roundX(x);this.posY=re.tile.roundY(y);return this;},setTile:function(xt,yt){this.setTileX(xt);this.setTileY(yt);return this;},setTileX:function(value){this.posX=Math.floor(value*this.sizeX);return this;},getTileX:function(){return Math.floor(this.posX/this.sizeX);},setTileY:function(value){this.posY=Math.floor(value*this.sizeY);return this;},getTileY:function(){return Math.floor(this.posY/this.sizeY);}});re.c('playlist');re.sound=re.c('sound').global({enabled:true}).namespace({hasEvent:false,loops:0}).extend({play:function(loop){if(!this.sound||!re.sound.enabled)return this;var c=this.sound;var that=this;c.currentTime=0;c.play();if(loop){this.sound_loops=0;if(!this.sound_hasEvent){this.sound_hasEvent=true;c.addEventListener('ended',function(){that.signal('sounded',that.sound_loops,loop);if(loop==-1||that.sound_loops<loop){c.currentTime=0;that.sound_loops++;}},false);}}
return this;},resume:function(){this.sound.play();return this;},pause:function(){this.sound.pause();return this;},currentTime:function(){return this.sound.currentTime;},ended:function(){return this.sound.ended;}});re.c('arraymap').inherit({lengthX:0,lengthY:0}).extend({value:0,set:function(x,y,value){while(y>=this.map.length){var m=new Array(this.map[0]);for(var l in m){m[l]=this.value;}
this.map.push(m);}
while(x>=this.map[this.map.length-1].length){for(var k=0;k<this.map.length;k++){this.map[k].push(this.value);}}
this.lengthX=this.map[y].length;this.lengthY=this.map.length;this.map[y][x]=value;return this;},within:function(x,y){if(y<0||y>=this.lengthY||x<0||x>=this.lengthX){return false;}
return true;},get:function(x,y){if(this.within(x,y)){return this.map[y][x];}
return null;},copy:function(a){for(var y=0;y<a.length;y++){for(var x=0;x<a[0].length;x++){this.set(x,y,a[y][x]);}}
return this;}}).init(function(){this.map=[];});re.c('flicker').require('update timestep').implement('flick').init(function(){this.flicker_reels={};this.flicker_old={};this.flicker_reel={};this.flicker_flickering='';}).extend({flicker_stop:function(){if(this.flickering()){this.signal('animated',this.flicker_flickering);this.flicker_flickering='';this.stepProgress=0;this.frameX=this.flicker_oldX;this.frameY=this.flicker_oldY;this.removeSignal('update',this.flicker_update);}
return this;},flicker_update:function(t){this.timestep(t,function(){var c=this.flicker_reel;if(this.flicker_frame==this.flicker_reel.frames.length){if(c.loops==-1||--this.flicker_loops>=1){this.flicker_frame=0;}else{this.flicker_stop();return;}}
this.flick(c.frames[this.flicker_frame]);this.flicker_frame++;});},addFlicker:function(id,loops,duration,frames){if(typeof id=='object'){for(var i in id){if(!id.hasOwnProperty(i))continue;var c=id[i].slice();c.unshift(i);this.addFlicker.apply(this,c);}
return this;}
if(typeof frames=='string')frames=frames.split(' ');this.flicker_reels[id]={frames:frames,duration:duration,loops:loops};return this;},removeFlicker:function(id){if(typeof id=='object'){for(var i in id){if(!id.hasOwnProperty(i))continue;this.removeFlicker.call(this,id[i]);}
return this;}
delete this.flicker_reels[id];return this;},flicker:function(id,loops,duration,frames){if(arguments.length==0){return this.flicker_stop();}
if(id==this.flicker_flickering)return;if(!this.flicker_reels[id]){return this;}
var r=this.flicker_reels[id];var c=this.flicker_reel;c.loops=(isNaN(loops))?r.loops:loops;c.duration=(isNaN(duration))?r.duration:duration;c.frames=(typeof frames=='object')?frames:r.frames;this.flicker_loops=c.loops;this.stepProgress=0;this.stepSize=c.duration/c.frames.length;this.flicker_oldX=this.frameX;this.flicker_oldY=this.frameY;this.flicker_frame=0;this.flick(c.frames[this.flicker_frame++]);if(!this.flickering()){this.addSignal('update',this.flicker_update);}
this.flicker_flickering=id;return this;},flickering:function(id){if(id){return this.flicker_flickering==id;}
return this.flicker_flickering!='';}});re.c('timestep').inherit({stepProgress:0,stepSize:0.3}).extend({timestep:function(progress,callback,context){this.stepProgress+=progress;while(this.stepProgress>=this.stepSize){callback.call((context)?context:this);this.stepProgress-=this.stepSize;}}})
re.c('storage').init(function(c,type){this.storage=(type=='session')?sessionStorage:localStorage;}).extend({length:function(){return this.storage.length;},key:function(index){return this.storage.key(index);},getItem:function(key){return this.storage.getItem(key);},getJson:function(key){return JSON.parse(this.getItem(key));},setItem:function(key,data){if(typeof data!='number'||typeof data!='string'){data=JSON.stringify(data);}
this.storage.setItem(key,data);return this;},removeItem:function(key){this.storage.removeItem(key);return this;},clear:function(){this.storage.clear();return this;}})
re.log=function(){try{console.log.apply(console,arguments);}catch(e){try{opera.postError.apply(opera,arguments);}catch(e){alert(Array.prototype.join.call(arguments," "));}}};re.c('log').extend('log',re.log);re.c('polyfill').extend({requestAnimationFrame:function(callback,canvas){return requestAnimFrame(callback,canvas);}}).run(function(){window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60);};});re.c('random').extend({random:function(max,min){switch(arguments.length){case 0:return Math.random();case 1:return Math.random()*max;case 2:return Math.random()*(max-min+1)+min;}},randomInt:function(max,min){return Math.floor(this.random.apply(this,arguments));}}).run(function(){var b=re.e('random');re.random=b.random;re.randomInt=b.randomInt;b.dispose();});re.scene=function(title){var s=re.c('scene');var k=title.split(' ');if(k.length>1){title=k.pop();for(var b in k){arguments.callee.apply(s,arguments);}}
if(title.charAt(0)=='-'){delete s._scenes[title.substr(1)];return s;}else if(s._scenes[title]){var current=arguments.callee.current;var t=s._scenes[current];if(t&&typeof t.scene_exit=='function'){t.scene_exit.call(t,title);}
arguments.callee.current=title;s.curent=title;t=s._scenes[title];if(typeof t.scene_enter=='function'){t.scene_enter.apply(t,Array.prototype.slice.call(arguments,1));}}else{re.e('scene:'+title);}
return s._scenes[title];};re.c('scene').global({_scenes:{}}).init(function(c,title){c._scenes[title]=this;this.sceneName=title;}).dispose(function(c){delete c._scenes[this.sceneName];}).extend({enter:function(m){this.scene_enter=m;return this;},exit:function(m){this.scene_exit=m;return this;},scene:function(){return re.scene.apply(this,arguments);}});re.c('sheet').global({sheet:function(map,padX,padY,sizeX,sizeY){var frameWidth=sizeX||re.tile.sizeX;var frameHeight=sizeY||re.tile.sizeY;if(padX){frameWidth+=padX;}
if(padY){frameHeight+=padY;}
var x;var y;for(var p in map){x=map[p][0]||0;y=map[p][1]||0;re.c(p).require('sprite').extend({frame:{x:x,y:y},size:{x:frameWidth,y:frameHeight},bitmap:this.bitmap});}
return this;}}).require('tile').extend({sheet:re.sheet});re.sheet=re.c('sheet').sheet;re.c('support').global({support:function(s){var that=re.c('support');if(arguments.length>1){var d;for(var i=0;i<arguments.length;i++){d=arguments[i];if(that.support(d)){return d;}}
return false;}
var k=s.split(' ');var stat=true;for(var j in k){stat=stat&&!!that[k[j]];}
return stat;}}).extend({support:function(s){return re.c('support').call(this,s);}}).run(function(){var c=re.c('support');re.support=c.support;c.canvas=!!document.createElement('canvas').getContext;c.text=!!(c.canvas&&typeof document.createElement('canvas').getContext('2d').fillText=='function');var ele=document.createElement('audio');try{if(c.audio=!!ele.canPlayType){c.ogg=ele.canPlayType('audio/ogg; codecs="vorbis"');c.mp3=ele.canPlayType('audio/mpeg;');c.wav=ele.canPlayType('audio/wav; codecs="1"');c.aac=ele.canPlayType('audio/x-m4a;')||ele.canPlayType('audio/aac;');for(var i in c){if(c[i]=='no'||c[i]==''){c[i]=false;}}}}catch(e){}
try{c.localstorage=!!localStorage.getItem;}catch(e){c.localstorage=false;}
c.worker=!!window.Worker;c.webgl=!!window.WebGLRenderingContext;c.touch='ontouchstart'in window;});